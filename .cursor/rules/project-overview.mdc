---
alwaysApply: true
---

# Project Overview

- ワークスペース全体のプロジェクト概要
- 4つのリポジトリで構成されるホームラボ環境

## Workspace Structure

| リポジトリ | 説明 | 主な内容 |
| -- | -- | -- |
| `price-monitoring` | メインアプリケーション | 価格監視Webアプリ（Frontend/Backend/Auth Provider） |
| `infra` | インフラ設定管理 | Ansible Playbooks、サーバー設定ファイル、セットアップ手順 |
| `k8s` | Kubernetesマニフェスト | 本番環境のk8sリソース定義（GitOps） |
| `k8s-secret` | シークレット管理 | 公開できないSecretリソース（プライベートリポジトリ） |

## System Architecture

```mermaid
graph TB
  subgraph "開発環境"
    docker[Docker Compose]
  end

  subgraph "本番環境 - 自宅Kubernetes"
    subgraph "Control Plane"
      master1[master-1<br/>10.15.100.10]
    end

    subgraph "Worker Nodes"
      worker1[worker-1<br/>10.15.100.11]
      worker2[worker-2<br/>10.15.100.12]
      worker3[worker-3<br/>10.15.200.10]
    end

    subgraph "Infrastructure Components"
      argocd[ArgoCD]
      longhorn[Longhorn]
      metallb[MetalLB]
      cilium[Cilium CNI]
      ingress[Ingress NGINX]
    end

    subgraph "Application Stack"
      frontend[Next.js]
      backend[Rails API]
      sidekiq[Sidekiq]
      playwright[Playwright]
      auth[Auth Provider]
    end

    subgraph "Databases"
      mysql[(MySQL)]
      redis[(Redis)]
    end
  end

  subgraph "External Services"
    vps[VPS - proxy-1<br/>Squid Proxy]
    datadog[Datadog]
    bugsnag[BugSnag]
    cloudflare[Cloudflare]
  end

  docker --> |CI/CD| argocd
  argocd --> |GitOps| frontend & backend & sidekiq & auth
  playwright --> |Scraping via Proxy| vps
  frontend & backend --> datadog & bugsnag
  ingress --> cloudflare
```

## Application Overview

### price-monitoring

- Web上の商品価格を収集・分析するツール
- 対応プラットフォーム:
  - ヤフオク、ヤフーフリマ、メルカリ（フリマ系）
  - じゃんぱら、イオシス、パソコン工房、リコレ（中古PC系）
- 主な機能:
  - 商品価格のクロール・収集
  - 相場分析・日次サマリー
  - カテゴリ・商品管理

### Technology Stack

Frontend:

- Next.js 14（App Router）+ TypeScript + TailwindCSS + daisyUI

Backend:

- Rails 7.1 + Ruby 3.2.2 + MySQL 8.0 + Redis

Auth Provider:

- Rails + Devise + Doorkeeper（OpenID Connect Provider）

Batch Processing:

- Sidekiq + Playwright（Chromiumベースのスクレイピング）

## Infrastructure Overview

### Proxmox VE Cluster

- 2台の物理ノード（pve-1, pve-2）
- EVPN Zoneによるオーバーレイネットワーク
- VXLAN L2ネットワークで異なる物理ノード間のVM疎通

### Kubernetes Cluster

- Master Node x 1、Worker Node x 3 構成
- CNI: Cilium
- Storage: Longhorn（分散ストレージ）
- Load Balancer: MetalLB
- GitOps: ArgoCD

### Network Configuration

| サブネット | 用途 |
| -- | -- |
| 192.168.0.0/24 | 物理ネットワーク |
| 10.15.100.0/24 | EVPN VNet (pve-1) |
| 10.15.200.0/24 | EVPN VNet (pve-2) |

### Access Control

- Tailscaleによるセキュアなリモートアクセス
- SSHポート変更によるセキュリティ強化

## CI/CD Pipeline

```mermaid
sequenceDiagram
  participant dev as Developer
  participant github as GitHub
  participant actions as GitHub Actions
  participant registry as Private Registry
  participant argocd as ArgoCD
  participant k8s as Kubernetes

  dev->>github: git push
  github->>actions: trigger CI/CD
  actions->>actions: docker build
  actions->>registry: docker push
  actions->>github: update k8s manifests
  argocd->>github: detect changes
  argocd->>k8s: apply manifests
```

## Repository Relationships

```mermaid
graph LR
  subgraph "アプリケーション開発"
    pm[price-monitoring]
  end

  subgraph "インフラ管理"
    infra[infra]
    k8s[k8s]
    k8s_secret[k8s-secret]
  end

  pm -->|CI/CD| k8s
  infra -->|Ansible| k8s
  k8s_secret -->|Secrets| k8s

  pm -.->|コードベース| pm
  infra -.->|サーバー設定| infra
  k8s -.->|マニフェスト| k8s
  k8s_secret -.->|Secret定義| k8s_secret
```

## Key URLs

### Production

| サービス | URL |
| -- | -- |
| price-monitoring | https://price-monitoring.kuroweb.net |
| Auth Provider | https://auth.price-monitoring.kuroweb.net |
| ArgoCD | https://argocd.kuroweb.net |
| Longhorn | https://longhorn.kuroweb.net |
| Portainer | https://portainer.kuroweb.net |

### Development

| サービス | URL |
| -- | -- |
| メインアプリ | https://dev.price-monitoring.com |
| 認証プロバイダー | https://dev.auth.price-monitoring.com |

## Development Workflow

- ローカル開発: Docker Compose
- タスクランナー: just
- コマンド例:
  - `just up` - コンテナ起動
  - `just down` - コンテナ停止
  - `just logs` - ログ確認
  - `just rspec` - テスト実行

## Command Execution Guide

- **重要**: すべてのコマンドはDockerコンテナ経由で実行する
- ホストマシンに直接 rails, rspec, npm 等はインストールされていない
- 作業ディレクトリ: `price-monitoring/`（docker-compose.ymlがある場所）

### Backend (Rails) コマンド

```bash
# RSpec テスト実行
docker compose run --rm backend rspec

# 特定のテストファイル実行
docker compose run --rm backend rspec spec/path/to/spec.rb

# Rails コンソール
docker compose run --rm backend rails c

# マイグレーション実行
docker compose run --rm backend rails db:migrate

# Seed データ投入
docker compose run --rm backend rails db:seed

# Bundler
docker compose run --rm backend bundle install
```

### Frontend (Next.js) コマンド

```bash
# 依存関係インストール
docker compose run --rm frontend npm install

# ビルド
docker compose run --rm frontend npm run build

# Lint
docker compose run --rm frontend npm run lint
```

### Auth Provider コマンド

```bash
# Rails コンソール
docker compose run --rm auth_provider rails c

# マイグレーション
docker compose run --rm auth_provider rails db:migrate
```

### コンテナ名一覧

| コンテナ名 | 用途 |
| -- | -- |
| `backend` | Rails API サーバー |
| `frontend` | Next.js サーバー |
| `auth_provider` | OpenID Connect Provider |
| `sidekiq` | バックグラウンドジョブ |
| `spring` | Rails プリローダー（テスト高速化） |
| `mysql` | データベース |
| `redis` | キャッシュ・ジョブキュー |

### 起動中コンテナへのコマンド実行

```bash
# 起動中のコンテナ内でコマンド実行（exec）
docker compose exec backend rails c

# 新規コンテナを起動してコマンド実行（run --rm）
docker compose run --rm backend rails c
```

- `exec`: 起動中のコンテナに接続（コンテナが起動していないとエラー）
- `run --rm`: 新規コンテナを起動して実行後に削除（コンテナ停止中でも実行可能）

## Monitoring & Observability

- APM: Datadog
- Error Tracking: BugSnag
- Logging: 各コンテナのログ出力
