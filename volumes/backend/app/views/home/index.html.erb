<% content_for :head do %>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      line-height: 1.6;
    }
    h1 {
      color: #333;
      border-bottom: 2px solid #007bff;
      padding-bottom: 10px;
    }
    .status {
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
    }
    .logged-in {
      background: #d4edda;
      border-left: 4px solid #28a745;
    }
    .logged-out {
      background: #f8d7da;
      border-left: 4px solid #dc3545;
    }
    .user-info {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 5px;
      margin: 15px 0;
    }
    .user-info dt {
      font-weight: bold;
      color: #495057;
      margin-top: 10px;
    }
    .user-info dd {
      margin-left: 20px;
      color: #6c757d;
    }
    .actions {
      margin: 30px 0;
    }
    .btn {
      display: inline-block;
      padding: 10px 20px;
      margin: 5px;
      text-decoration: none;
      border-radius: 5px;
      font-weight: bold;
      transition: background-color 0.3s;
      border: none;
      cursor: pointer;
    }
    .btn-primary {
      background: #007bff;
      color: white;
    }
    .btn-primary:hover {
      background: #0056b3;
    }
    .btn-danger {
      background: #dc3545;
      color: white;
    }
    .btn-danger:hover {
      background: #c82333;
    }
    .alert {
      padding: 15px;
      margin: 20px 0;
      border-radius: 5px;
    }
    .alert-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .alert-danger {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
  </style>
<% end %>
<h1>Price Monitoring - OIDC Test</h1>
  <% if notice %>
    <div class="alert alert-success"><%= notice %></div>
  <% end %>
  <% if alert %>
    <div class="alert alert-danger"><%= alert %></div>
  <% end %>
  <% if logged_in? %>
    <div class="status logged-in">
      <h2>✓ Logged In</h2>
      <p>You are successfully authenticated via OIDC!</p>
    </div>
    <div class="user-info">
      <h3>User Information</h3>
      <dl>
        <dt>Provider:</dt>
        <dd><%= current_user&.dig(:provider) || current_user&.[]('provider') %></dd>
        <dt>User ID (sub):</dt>
        <dd><%= current_user&.dig(:uid) || current_user&.[]('uid') %></dd>
        <dt>Email:</dt>
        <dd><%= current_user&.dig(:email) || current_user&.[]('email') %></dd>
        <% if current_user&.dig(:name) || current_user&.[]('name') %>
          <dt>Name:</dt>
          <dd><%= current_user&.dig(:name) || current_user&.[]('name') %></dd>
        <% end %>
      </dl>
    </div>
    <div class="user-info">
      <h3>Session Information</h3>
      <dl>
        <dt>Access Token (first 20 chars):</dt>
        <dd><%= session[:access_token]&.first(20) %>...</dd>
        <dt>Refresh Token (first 20 chars):</dt>
        <dd><%= session[:refresh_token]&.first(20) %>...</dd>
        <dt>Token Expires At:</dt>
        <dd><%= Time.at(session[:expires_at]).to_s if session[:expires_at] %></dd>
        <% if session[:expires_at] %>
          <dt>Time Until Expiration:</dt>
          <dd>
            <% remaining_seconds = session[:expires_at] - Time.current.to_i %>
            <% if remaining_seconds > 0 %>
              <%= Time.at(remaining_seconds).utc.strftime("%H:%M:%S") %>
              <% if remaining_seconds < 300 %>
                <span style="color: red;">(Expiring soon!)</span>
              <% end %>
            <% else %>
              <span style="color: red;">Expired</span>
            <% end %>
          </dd>
        <% end %>
      </dl>
    </div>
    <div class="actions">
      <%= button_to "Logout", logout_path, method: :delete, class: "btn btn-danger" %>
    </div>
  <% else %>
    <div class="status logged-out">
      <h2>✗ Not Logged In</h2>
      <p>Please log in to test the OIDC authentication flow.</p>
    </div>
    <div class="actions">
      <%= link_to "Login with Auth Provider", "/auth/auth_provider", class: "btn btn-primary", data: { turbo: false } %>
    </div>
  <% end %>
  <hr style="margin: 40px 0;">
  <div style="color: #6c757d; font-size: 14px;">
    <h3>OIDC Configuration</h3>
    <dl>
      <dt>Issuer:</dt>
      <dd><%= ENV.fetch('OIDC_ISSUER', 'https://dev.auth.price-monitoring.com') %></dd>
      <dt>Client ID:</dt>
      <dd><%= ENV['OIDC_CLIENT_ID'] ? "Configured (#{ENV['OIDC_CLIENT_ID'][0..10]}...)" : "Not configured" %></dd>
      <dt>Scopes:</dt>
      <dd>openid, email, profile</dd>
    </dl>
  </div>
